<% layout("/layouts/boilerplate") -%>

<body>
  <div class="container py-5">
    <!-- Listing Card -->
    <div class="card shadow-sm border-0 rounded-4 overflow-hidden mb-5">
      <img
        src="<%= listing.Image %>"
        alt="<%= listing.title %>"
        class="card-img-top"
        style="height: 450px; object-fit: cover"
      />

      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h2 class="fw-bold text-dark mb-0"><%= listing.title %></h2>
          <span class="badge bg-danger fs-6 px-3 py-2"
            >৳ <%= listing.price.toLocaleString("en-IN") %></span
          >
        </div>

        <p class="text-muted mb-4 fs-6"><%= listing.description %></p>

        <div class="d-flex align-items-center mb-4">
          <i class="bi bi-geo-alt-fill text-danger me-2"></i>
          <span class="fw-medium"
            ><%= listing.location %>, <%= listing.country %></span
          >
        </div>

        <div class="d-flex gap-3">
          <a
            href="/listings/<%= listing._id %>/edit"
            class="btn btn-outline-dark px-4 rounded-pill fw-semibold"
          >
            <i class="bi bi-pencil-square me-2"></i>Edit Listing
          </a>

          <form
            method="POST"
            action="/listings/<%= listing._id %>?_method=DELETE"
            onsubmit="return confirm('Are you sure you want to delete this listing?')"
          >
            <button
              type="submit"
              class="btn btn-danger px-4 rounded-pill fw-semibold"
            >
              <i class="bi bi-trash3 me-2"></i>Delete Listing
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Review Section -->
    <div class="card border-0 shadow-sm rounded-4 mb-5">
      <div class="card-body p-4">
        <h4 class="fw-bold mb-4 text-dark">
          <i class="bi bi-chat-dots-fill text-danger me-2"></i>Reviews
        </h4>

        <!-- Existing Reviews -->
        <% if (listing.reviews && listing.reviews.length > 0) { %>
        <div class="row row-cols-1 row-cols-md-2 g-4">
          <% listing.reviews.forEach(review => { %>
          <div class="col">
  <div class="card h-100 border-0 shadow-sm rounded-3 p-3 position-relative">
    <form
      action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
      method="POST"
      onsubmit="return confirm('Delete this review?')"
      class="position-absolute"
      style="top: 10px; right: 10px"
    >
      <button
        type="submit"
        class="btn btn-sm btn-outline-danger rounded-pill"
      >
        <i class="bi bi-trash"></i>
      </button>
    </form>

    <div class="d-flex align-items-center mb-2">
      <div
        class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
        style="width: 38px; height: 38px; font-size: 15px"
      >
        G
      </div>
      <strong class="text-dark">Guest</strong>
    </div>

    <div class="text-warning mb-2">
      <% for (let i = 0; i < review.rating; i++) { %>
        <i class="bi bi-star-fill"></i>
      <% } %>
      <% for (let i = review.rating; i < 5; i++) { %>
        <i class="bi bi-star"></i>
      <% } %>
    </div>

    <p class="text-muted mb-0"><%= review.comment %></p>
  </div>
</div>

          <% }) %>
        </div>
        <% } else { %>
        <p class="text-muted">No reviews yet. Be the first to leave one!</p>
        <% } %>

        <!-- Add Review Form -->
        <form
          action="/listings/<%= listing._id %>/reviews"
          method="POST"
          class="mt-5 needs-validation"
          novalidate
        >
          <h5 class="fw-bold mb-3 text-dark">Add Your Review</h5>

          <div class="mb-3">
            <label for="rating" class="form-label fw-semibold">Rating</label>
            <select
              name="review[rating]"
              id="rating"
              class="form-select rounded-3"
              required
            >
              <option value="" selected disabled>Select Rating</option>
              <option value="1">⭐ 1 - Poor</option>
              <option value="2">⭐⭐ 2 - Fair</option>
              <option value="3">⭐⭐⭐ 3 - Good</option>
              <option value="4">⭐⭐⭐⭐ 4 - Very Good</option>
              <option value="5">⭐⭐⭐⭐⭐ 5 - Excellent</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="comment" class="form-label fw-semibold">Comment</label>
            <textarea
              name="review[comment]"
              id="comment"
              rows="3"
              class="form-control rounded-3"
              placeholder="Share your experience..."
              required
            ></textarea>
            <div class="invalid-feedback">
              Please add a comment for your review.
            </div>
          </div>

          <button
            type="submit"
            class="btn btn-danger rounded-pill px-4 fw-semibold"
          >
            <i class="bi bi-send me-2"></i>Submit Review
          </button>
        </form>
      </div>
    </div>

    <!-- Back Button -->
    <div class="text-center">
      <a
        href="/listings"
        class="btn btn-outline-secondary rounded-pill px-4 fw-semibold"
      >
        <i class="bi bi-arrow-left me-2"></i>Back to Listings
      </a>
    </div>
  </div>
</body>
